# Tear Film Theoretical Spectra Generator Configuration
# Edit these parameters to customize your measurement ranges

# Parameter Ranges (expanded beyond Algorithm_eye_test_4.xml constraints)
# DLL accepts values outside algorithm ranges, as we've seen with client's values
parameters:
  # Lipid layer thickness (nm)
  lipid:
    min: 9           # Minimum accepted lipid thickness
    max: 250         # Maximum accepted lipid thickness
    step: 5          # Step size
    
  # Aqueous layer thickness (nm)
  aqueous:
    min: 800         # Minimum accepted aqueous thickness
    max: 12000       # Maximum accepted aqueous thickness
    step: 10         # Step size
    
  # Mucus layer roughness (Angstroms)
  roughness:
    min: 600         # Minimum accepted roughness
    max: 2750        # Maximum accepted roughness
    step: 50         # Step size

# Fixed Parameters
fixed:
  mucus_thickness: 500    # Mucus layer thickness (nm) - kept constant

# Wavelength Configuration
wavelengths:
  file: "Wavelengths813.csv"  # Options: Wavelengths813.csv, Wavelengths1024.csv, Wavelengths2061.csv
  # Alternative: specify custom range
  # custom:
  #   min: 550
  #   max: 1100
  #   points: 500

# Measurement spectra configuration
measurements:
  enabled: true
  base_dir: "data/measurements"
  format: "txt"  # csv, xlsx, or txt
  wavelength_column: 0  # Column index for wavelength data (0-based)
  reflectance_column: 1  # Column index for reflectance data (0-based)
  header_rows: 4  # Number of header rows to skip
  file_pattern: "*.txt"  # File pattern to match (e.g., "*.csv", "*.txt", "measurement_*.xlsx")

# Signal Analysis Configuration
analysis:
  # Wavelength range of interest for analysis (nm)
  # Based on notebook exploration: 600-1120nm captures the relevant spectral features
  wavelength_range:
    min: 600   # Start of analysis region (nm)
    max: 1120  # End of analysis region (nm)
  
  detrending:
    default_cutoff_frequency: 0.008  # Default high-pass filter cutoff
    filter_order: 3  # Butterworth filter order
  peak_detection:
    default_prominence: 0.0001  # Default peak prominence threshold
    min_height: null  # Minimum peak height (null for no limit)
  quality_gates:
    enabled: true
    min_quality_score: 0.5
    min_peaks: 3
    min_signal_amplitude: 0.02
    min_wavelength_span_nm: 150.0
  edge_case_detection:
    enabled: true
    threshold_high_score: 0.9    # Flag scores >= this as exceptional (algorithm outperforming)
    threshold_low_score: 0.3     # Flag scores <= this as poor fits
    threshold_no_fit: 0.4        # If best score <= this, flag as "no good fit found"
    # Acceptable parameter ranges (match the search ranges - these are physically/biologically feasible)
    # If best fit is outside these, it's flagged as potentially invalid
    acceptable_ranges:
      lipid:
        min: 9                   # Minimum accepted lipid thickness (nm)
        max: 250                 # Maximum accepted lipid thickness (nm)
      aqueous:
        min: 800                 # Minimum accepted aqueous thickness (nm)
        max: 12000               # Maximum accepted aqueous thickness (nm)
      roughness:
        min: 600                 # Minimum accepted roughness (Å)
        max: 2750                # Maximum accepted roughness (Å)
  grid_search:
    use_temporal_seeding: true
    temporal_window_multiplier: 0.3
    confidence_threshold_for_narrow_window: 0.8
    max_total_evals: null
    coarse:
      top_k: 50  # Increased to allow more candidates for refinement
      # Coarse search - optimized for ~20 min runtime
      lipid: {min: 9, max: 250, step: 40}        # Accepted range for lipid
      aqueous: {min: 800, max: 12000, step: 200} # Accepted range for aqueous
      roughness: {min: 600, max: 2750, step: 500}  # Accepted range for roughness
    refine:
      lipid: {window_nm: 20, step_nm: 5}
      aqueous: {window_nm: 40, step_nm: 10}
      roughness: {window_A: 200, step_A: 25}
      max_refine_candidates: 5000
  metrics:
    residual:
      tau_rmse: 0.015
      max_rmse: 0.1
    peak_count:
      wavelength_tolerance_nm: 5.0
    peak_delta:
      tolerance_nm: 5.0
      tau_nm: 15.0
      penalty_unpaired: 0.05
    phase_overlap:
      resample_points: 1024
      window: "hann"
    temporal_continuity:
      enabled: false
      tau_lipid_nm: 10.0
      tau_aqueous_nm: 30.0
      tau_roughness_A: 150.0
    composite:
      weights:
        # Balanced weights: peak matching is important for visual alignment
        # Based on notebook exploration: peaks/valleys alignment matters for fit quality
        peak_count: 0.10         # Peak count matching (important for oscillation matching)
        peak_delta: 0.15         # Peak position alignment (important for phase alignment)
        phase_overlap: 0.2      # FFT-based phase coherence (reduced weight)
        residual: 0.5           # RMSE/MAE fit quality
        quality: 0.1            # Measurement quality score
        temporal_continuity: 0.0  # Disabled for single measurements


# File Paths (relative to project root)
paths:
  dll: "src/SpAnalizer.dll"
  algorithm: "configs/Algorithm_eye_test_4.xml"
  configuration: "configs/Configuration1.xml"
  stack: "configs/Stack_eye_test.xml"
  materials: "data/Materials"
  wavelengths_dir: "data/wavelengths"
  measurements: "data/measurements"  # Directory containing measurement spectra

# Output Configuration
output:
  format: "npy"           # Options: "npy", "xlsx"
  base_dir: "outputs"     # Output directory
  include_plots: true     # Generate interactive plots
  plot_format: "html"     # Options: "html", "png", "pdf"

# Plot Configuration
plotting:
  # Which spectra to plot (indices or "sample" for automatic selection)
  spectra_to_plot: "sample"  # Options: "sample", "all", or specific indices like [[0,0,0], [1,2,1]]
  
  # Number of sample spectra to plot if "sample" is selected
  num_samples: 6
  
  # Plot appearance
  plot_style:
    width: 1000
    height: 600
    title_size: 16
    axis_label_size: 14
    line_width: 2
    measured_color: "red"
    theoretical_color: "blue"

# Presets for common measurement scenarios
presets:
  # Quick test - small parameter space around requested values
  quick_test:
    lipid: {min: 125, max: 135, step: 5}      # Around requested 129nm
    aqueous: {min: 1000, max: 1200, step: 25} # Near typical values
    roughness: {min: 2550, max: 2600, step: 50}  # Near typical values
    
  # Medium resolution scan
  medium_scan:
    lipid: {min: 9, max: 250, step: 10}
    aqueous: {min: 800, max: 3000, step: 50}
    roughness: {min: 600, max: 2750, step: 100}
    
  # High resolution scan (warning: generates many spectra!)
  high_resolution:
    lipid: {min: 9, max: 250, step: 2}
    aqueous: {min: 800, max: 3000, step: 10}
    roughness: {min: 600, max: 2750, step: 25}
    
  # Lipid thickness focus
  lipid_focus:
    lipid: {min: 9, max: 250, step: 5}
    aqueous: {min: 900, max: 1000, step: 50}  # Keep aqueous relatively constant
    roughness: {min: 1500, max: 1700, step: 100}  # Keep roughness relatively constant

# Active preset (comment out to use manual parameters above)
# active_preset disabled
# active_preset: "high_resolution"

# Advanced Options
advanced:
  # Memory management
  chunk_size: 1000      # Process in chunks to manage memory for large parameter spaces
  
  # Parallel processing (if supported)
  use_parallel: false   # Enable parallel processing (experimental)
  num_processes: 4      # Number of parallel processes
  
  # Validation
  validate_materials: true    # Check that all material files exist
  validate_wavelengths: true  # Check wavelength file format
  
  # Debugging
  verbose: true         # Print detailed progress information
  save_temp_files: false # Keep temporary XML files for debugging

# UI (Streamlit) Configuration
ui:
  enabled: true                 # If true, runner can launch the Streamlit app with --ui
  page_title: "Tear Film Spectra Explorer"
  use_sidebar: true             # Put sliders in the sidebar
  default_values:               # Initial slider values (optional; midpoints used if omitted)
    lipid: 130
    aqueous: 1000
    roughness: 2000
  client_reference_scoring:
    enabled: false              # Enable client reference scoring by default
    default_lipid: 62.3         # Default client lipid thickness (nm) - range: 9-250
    default_aqueous: 1000.0     # Default client aqueous thickness (nm) - range: 800-12000
    default_roughness: 1200.0   # Default client roughness (Å) - range: 600-2750
