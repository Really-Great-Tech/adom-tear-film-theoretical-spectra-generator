# Tear Film Theoretical Spectra Generator Configuration
# Edit these parameters to customize your measurement ranges

# Parameter Ranges (expanded beyond Algorithm_eye_test_4.xml constraints)
# Client testing revealed optimal values outside algorithm ranges (e.g., lipid=60.1nm, aqueous=-2.0nm)
parameters:
  lipid:
    min: 0
    max: 500
    step: 5         # Step size for manual slider adjustment
  aqueous:
    min: -20
    max: 12000
    step: 10        # Step size for manual slider adjustment
  roughness:
    min: 0
    max: 3000
    step: 50        # Step size for manual slider adjustment

# Fixed Parameters
fixed:
  mucus_thickness: 500    # Mucus layer thickness (nm) - kept constant

# Wavelength Configuration
wavelengths:
  file: "Wavelengths1024.csv"  # Options: Wavelengths813.csv, Wavelengths1024.csv, Wavelengths2061.csv

# Measurement spectra configuration
measurements:
  enabled: true
  format: "txt"  # csv, xlsx, or txt
  wavelength_column: 0  # Column index for wavelength data (0-based)
  reflectance_column: 1  # Column index for reflectance data (0-based)
  header_rows: 4  # Number of header rows to skip
  file_pattern: "*.txt"  # File pattern to match (e.g., "*.csv", "*.txt", "measurement_*.xlsx")

# Signal Analysis Configuration
analysis:
  detrending:
    default_cutoff_frequency: 0.005  # Default high-pass filter cutoff (lowered to preserve more oscillation detail)
    filter_order: 3  # Butterworth filter order
  peak_detection:
    default_prominence: 0.0005  # Default peak prominence threshold for measured spectra (lowered to catch more peaks)
    theoretical_prominence: 0.0005  # Same prominence for theoretical spectra (symmetric detection)
    min_height: null  # Minimum peak height (null for no limit)
  
  # Edge case detection for flagging results
  edge_case_detection:
    enabled: true
    threshold_high_score: 0.9  # Flag results with composite score > this as "suspiciously good"
    threshold_low_score: 0.3   # Flag results with composite score < this as "poor fit"
    threshold_no_fit: 0.4      # Flag results below this as "no fit detected"
    # Client's business-defined acceptable parameter ranges (for flagging, not search limits)
    client_accepted_ranges:
      lipid:
        min: 9
        max: 250
      aqueous:
        min: 800
        max: 12000
      roughness:
        min: 600
        max: 2750
  
  # Grid search configuration
  grid_search:
    use_temporal_seeding: true
    temporal_window_multiplier: 0.3
    confidence_threshold_for_narrow_window: 0.8
    max_total_evals: null
    coarse:
      top_k: 30  # Reduced for faster refinement
      # Coarse search - broad range to find best fits (client sometimes goes outside their own ranges)
      # Flagging will identify out-of-range results
      lipid: {min: 0, max: 400, step: 20}        # Broad range
      aqueous: {min: -20, max: 6000, step: 200}  # Broad range including negative (client allows this)
      roughness: {min: 300, max: 3000, step: 300}  # Broad range
    refine:
      lipid: {window_nm: 20, step_nm: 5}
      aqueous: {window_nm: 40, step_nm: 10}
      roughness: {window_A: 200, step_A: 25}
      max_refine_candidates: 5000
  
  # Metrics configuration
  metrics:
    residual:
      tau_rmse: 0.008   # Lower tau = steeper scoring (more separation between good/bad RMSE)
      max_rmse: 0.1
    peak_count:
      wavelength_tolerance_nm: 5.0
    peak_delta:
      tolerance_nm: 5.0
      tau_nm: 15.0
      penalty_unpaired: 0.05
    phase_overlap:
      resample_points: 1024
      window: "hann"
    # New metrics based on Shlomo's visual feedback
    cross_correlation:
      enabled: true  # Measures horizontal alignment without peak matching
    peak_spacing_consistency:
      enabled: false  # DISABLED - was rewarding wrong fits
    amplitude_alignment:
      enabled: false  # DISABLED - not helping visual quality
    oscillation_match:
      enabled: false  # DISABLED - misleading for smooth spectra
    monotonic_alignment:
      enabled: true   # CRITICAL: Penalizes criss-crossing (theoretical should stay on one side)
      focus_wavelength_min: 600.0   # Focus region start (nm)
      focus_wavelength_max: 1200.0  # Focus region end (nm)
      focus_reflectance_max: 0.06   # Only consider points with reflectance <= this value
      prefer_theoretical_below: true  # Client's fits are always at or below measured
    temporal_continuity:
      enabled: false
      tau_lipid_nm: 10.0
      tau_aqueous_nm: 30.0
      tau_roughness_A: 150.0
    composite:
      weights:
        # MONOTONIC_ALIGNMENT enforces HARD constraints: no criss-crossing, theo below measured
        # RESIDUAL (RMSE) ranks fits that pass the constraints
        # Fits violating constraints get near-zero monotonic_alignment score
        residual: 0.4                 # RMSE measures how close the curves are
        monotonic_alignment: 0.6      # HARD constraints: no criss-crossing, theo at/below measured
        cross_correlation: 0.0        # DISABLED - ignores amplitude, gives high scores for bad fits
        phase_overlap: 0.0            # DISABLED - FFT-based, also ignores amplitude
        oscillation_match: 0.0        # DISABLED - misleading for smooth spectra
        peak_count: 0.0               # DISABLED - unreliable for smooth spectra
        peak_spacing_consistency: 0.0 # DISABLED - was rewarding wrong fits
        amplitude_alignment: 0.0      # DISABLED - not helping visual quality
        peak_delta: 0.0               # Disabled - peak position matching is less critical
        quality: 0.0                  # Disabled - not used for ranking
        temporal_continuity: 0.0      # Disabled for now

# File Paths (relative to project root)
paths:
  dll: "src/SpAnalizer.dll"
  algorithm: "configs/Algorithm_eye_test_4.xml"
  configuration: "configs/Configuration1.xml"
  stack: "configs/Stack_eye_test.xml"
  materials: "data/Materials"
  wavelengths_dir: "data/wavelengths"
  measurements: "exploration/measurements"

# Output Configuration
output:
  format: "npy"           # Output format: "npy" or "xlsx"
  base_dir: "outputs"     # Base directory for output files
  include_plots: true     # Generate interactive plots
  plot_format: "html"     # Plot format: "html", "png", or "pdf"

# UI Configuration
ui:
  page_title: "Tear Film Spectra Explorer"
  default_values:
    lipid: 150
    aqueous: 850
    roughness: 2000
  
  # Client reference scoring - compare algorithm results with known client best fits
  client_reference_scoring:
    enabled: true # Set to true to enable scoring of client's known best parameters
    # Default parameters (can be overridden in UI)
    default_lipid: 62.3
    default_aqueous: -2
    default_roughness: 1200.0

# Plotting Configuration
plotting:
  plot_style:
    measured_color: "red"
    theoretical_color: "blue"
    grid_color: "lightgray"
    background_color: "white"

